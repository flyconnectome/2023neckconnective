---
title: "FAFB_DNs_Fig3"
author: "Tomke Stuerner"
date: "2024-09-26"
output: html_document
---
This script shows examples of how to load and use the annotations provided in the Supplemental file5 FAFB_DNs sheet.
- plot input and output partners by class as in Fig. 3a
- plot the DN clusters by their primary brain neuropil as in Fig. 3c
- plot the clusters that are closest to gustatory sensory neurons as in Fig. 3e

```{r setup, include=FALSE}
library(coconatfly)
library(dplyr)
library(ggplot2)
library(tidyr)
library(forcats)
```


```{r, include=FALSE}
# for users who might happen to have access to in progress flywire cell types
options(fafbseg.use_static_celltypes = T)
```


load the Supplemental file5 FAFB_DNs
```{r, include=TRUE}
FAFB_DNs = data.table::fread(file = '../Supplemental_files/Supplemental_file5_FAFB_DNs.tsv')
DN_ids = FAFB_DNs$root_id
```

Find upstream and downstream partners of DNs in FAFB-Flywire, weight>10
```{r, include=TRUE, eval=FALSE}
library(fafbseg)
DN_US = flywire_partner_summary2(DN_ids, partners = "input", version = 783,threshold=10)
DN_USsum <- aggregate(weight~super_class,DN_US,sum) 
DN_DS = flywire_partner_summary2(DN_ids, partners = "output", version = 783, threshold=10)
DN_DSsum <- aggregate(weight~super_class,DN_DS,sum) 
```

Same but using coconatfly (now the recommended method)
```{r, message=FALSE}
# note that threshold is >= for cf_partners and > for flywire_partner_summary2
DN_US=cf_partners(cf_ids(flywire = DN_ids), threshold = 11, partners = 'in')
# summarise 
DN_USsum <- DN_US |> 
  count(class, wt = weight, name = 'weight')

DN_DS=cf_partners(cf_ids(flywire = DN_ids), threshold = 11, partners = 'out')
# summarise 
DN_DSsum <- DN_DS |> 
  count(class, wt = weight, name = 'weight')

DN_USsum
DN_DSsum
```

Choose colours
```{r, include=TRUE}
delacroix = c("#C70E7B", "#FC6882", "#007BC3", "#54BCD1",
"#009F3F", "#8FDA04", "#AF6125", "#B25D91",
"#EF7C12", "#F4B95A", "#C23A4B", "#FBBB48", "#EFEF46", "#31D64D",
"#132157","#EE4244", "#D72000", "#1BB6AF", "#8B008B", "#551A8B","#808080")

names(delacroix) = c("magenta", "pink",
"blue", "cyan",
"darkgreen", "green",
"brown",
"mauve",
"darkorange", "orange",
"darkred", "darkyellow",
"yellow", "palegreen",
"navy","cerise",
"red", "marine",
"purple","darkpurple", "grey")

class_colours <- c("sensory" = delacroix[["green"]],
                   "sensory_ascending"  = delacroix[["darkgreen"]],
                   "descending" = delacroix[["pink"]],
                   "central" = delacroix[["cyan"]],
                   "ascending" = delacroix[["blue"]],
                   "motor" = delacroix[["purple"]],
                   "visual_projection" = delacroix[["brown"]],
                   "visual_centrifugal" = delacroix[["orange"]],
                   "optic" = delacroix[["red"]],
                   "endocrine" = "#A6A6A6")
```

Plot input partners by class as in Fig. 3a
```{r, include=TRUE}
DN_USsum <- DN_USsum |> 
  mutate(col = class_colours[class],
         percent = round(100*weight/sum(weight),1))

ggplot(DN_USsum, aes(x="", y=percent, fill=class)) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar("y", start=0) +
  scale_fill_manual(values=DN_USsum$col) +
  theme_minimal() +
  theme(axis.text.x=element_blank()) 
```
Plot output partners by class as in Fig. 3a
```{r, include=TRUE}
DN_DSsum <- DN_DSsum |> 
  mutate(col = class_colours[class],
         percent = round(100*weight/sum(weight),1))

ggplot(DN_DSsum, aes(x="", y=percent, fill=class)) +
  geom_bar(width = 1, stat = "identity") + 
  coord_polar("y", start=0) +
  scale_fill_manual(values=DN_DSsum$col) +  
  theme_minimal() +
  theme(axis.text.x=element_blank())
```

Plot the DN clusters by their primary brain neuropil. First compute some
summary statistics:
```{r}
plot_neuropilgroup_sensorycluster <- FAFB_DNs |> 
  filter(cluster!="sensory descending") |> 
  count(neuropilgroup, cluster) |> 
  # this adds a second count for number of neurons in each cluster
  add_count(cluster, wt = n, name = 'n_cluster') |> 
  mutate(normtypes=100*n/n_cluster)
plot_neuropilgroup_sensorycluster
```

Now let's plot a heatmap using those summary data
```{r}
neuropilgroup_order = c("PRW_FLA",
                        "GNG",
                        "OC_LO",
                        "PS_LAL",
                        "multi",
                        "SMP_SLP",
                        "VES",
                        "AVLP_AMMC_WED",
                        "PLP")

ggplot(data = plot_neuropilgroup_sensorycluster, 
       aes(
         x = cluster,
         y = factor(neuropilgroup, levels = neuropilgroup_order),
         fill = normtypes
       )) +
  geom_tile() +
  scale_fill_gradientn(colors = c("white", "black", "black")) +
  theme_minimal() +
  scale_x_discrete(name = "sensory clusters", limits = as.character(1:16)) +
  scale_y_discrete(name = "neuropilgroup") +
  theme(axis.text = element_text(size = 13))
```


```{r}
allsensory_ranking_type = data.table::fread(file = 'DN_ranking_df_783_sensory_combined_byDNtype.tsv')
# remove the sensory descending neurons
gustatoryplot <- allsensory_ranking_type |>
  filter(cluster != "sensory descending") |>
  mutate(cluster = fct_reorder(cluster, gustatory, .fun = median)) |>
  select(type, cluster, gustatory)
gustatoryplot
```

```{r}
gustatoryplot %>%
  ggplot(aes(
    x = reorder(cluster, gustatory),
    y = gustatory,
    fill = cluster
  )) +
  scale_fill_manual(
    values = c(
      "1" = "#007BC3",
      "2" = "#007BC3",
      "3" = "#8B008B",
      "4" = "#8B008B",
      "5" = "#132157" ,
      "6" = "#54BCD1",
      "7" = "#8FDA04",
      "8" = "#8FDA04",
      "9" = "#8FDA04",
      "10" = "#8B008B",
      "11" = "#8B008B",
      "12" = "#8B008B",
      "13" = "#009F3F",
      "14" = "#8FDA04",
      "15" = "#8B008B",
      "16" = "#8FDA04",
      "sensory descending" = "black"
    )
  ) +
  geom_boxplot()  +
  theme(legend.position = "none") +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank()) +
  theme(axis.text = element_text(size = 20))
```
