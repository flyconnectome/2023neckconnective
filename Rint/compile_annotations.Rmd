---
title: "single annotation sheet"
author: "Tomke Stuerner"
date: "2024-10-09"
output: html_document
---

```{r}
library(coconatfly)
library(dplyr)
library(data.table)
library(purrr)
```

Read all the annotation files into a list, converting all columns to character:
```{r}
ff = dir(path = "../Supplemental_files",
         pattern = 'Supplemental_file([5-9]|10|11|13).+',
         full.names = T)
names(ff) = sub("[^0-9]+([0-9]+)[^0-9]+", "\\1", ff)
ff = ff[as.character(sort(as.integer(names(ff))))]
# nb convert all columns to character (mostly because of issues with numeric ids)
dfs = lapply(ff, data.table::fread, colClasses='character')
```

Combine the dataframes
```{r}

# Row-bind data frames adding a column with the number of the sifile
combined_df <- bind_rows(dfs, .id = 'sifile') 
combined_df <- combined_df |>
  mutate(dataset = case_when(
    sifile %in% c(5, 8) ~ 'flywire',
    sifile %in% c(6, 9, 10, 13) ~ 'fanc',
    T ~ 'manc'
  )) %>%
  select(
    class,
    dataset,
    bodyid,
    cell_id,
    supervoxel_id,
    root_id,
    group,
    side,
    type,
    synonyms,
    soma_division,
    neuropil,
    neuropilgroup,
    cluster,
    hemilineage,
    manc_match_id,
    subclass
  )
combined_df
```

Let's write that out
```{r}
write.table(combined_df, file = "../Rint/combined_annotations.tsv", row.names=FALSE, sep="\t")
```

Let's look at what we've got: Number of ANs in each dataset
```{r}
combined_df |>
  filter(class == "AN") |>
  count(dataset)
```
Number of FANC neurons by class
```{r}
combined_df |>
  filter(dataset == "fanc") |>
  count(class)
```
Number of FANC unique types defined in this work: 1253
```{r}
combined_df |> 
  filter(dataset == "fanc") |> 
  summarise(unique_types = n_distinct(type))
```

coconatfly contains MANC and FAFB-Flywire types
So lets add the FANC annotations from this work to coconatfly 
```{r}
fanc_anns <- combined_df |> 
  filter(dataset == "fanc") |> 
  select(c("dataset", "root_id", "supervoxel_id", "side","soma_division", "class", "type", "synonyms",  "hemilineage",  "group","subclass","cell_id"))
fanc_anns
# If we we wanted to update the fanc ids, we could do:
# library(fancr)
# fanc_anns$root_id = fanc_latestid(fanc_anns$root_id)

write.table(fanc_anns, file = "../Rint/fanc-neckconnective-anns.tsv", row.names=FALSE, sep="\t")
```


